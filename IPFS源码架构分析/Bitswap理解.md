## 1.从协议的角度理解Bitswap

1.1 Bitswap是ipfs的数据交换模块，该模块主要功能有两个：

```
- 通过网络从别的节点获得块数据；
- 通过网络向别的节点提供块数据；
```

1.2 Bitswap是一个继续消息应答模式的通信协议；所有发出的消息包含wantlists或区块内容；

```
- 当一个节点收到wantlists的时候，该节点应该触发内部流程，将自己所拥有的且包含在wantlists中的块数据发送出去；
- 当一个节点收到所需的所有区块内容时候，会广播一条'cancle'消息，告知邻居节点不再需要区块内容；
- 当邻居节没有wantlist的区块数据时，邻居节点会继续广播wantlist，通过二级节点继续请求所需区块内容；
```



## 2.ipfs对Bitswap的实现步骤

2.1 区块请求接收端

- 从网络上，收到一个wantlist内容；
- 将对端所需的而且是当前节点所拥有的区块数据，放入请求队列中；
- 在节点请求队列中，为每一个请求区块创建一个task
- 当区块发送出去后，区块对应的task会被从队列中清除掉；
- task总数有限定；

2.2 区块请求发送端

- `WantBlocks`方法被激活

- 为每一个连接节点，建立一个消息队列；

- `want Manager` 保证每一个区块请求消息，都被邻居节点接收到；

- 每一个消息队列对象会不断轮询，做下面三件事情：

  ```
  1. 维护节点连接；
  2. 收集待发送的数据信息；
  3. 发送数据
  ```



> 接收区块和发送cancle消息，和上面的流程一样；